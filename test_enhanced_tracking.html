<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Tracking Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-canvas {
            border: 2px solid #ddd;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .feature-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .feature-card h3 {
            margin-top: 0;
            color: #333;
        }
        .color-swatch {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin: 2px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .centroid-display {
            width: 100px;
            height: 100px;
            border: 1px solid #ccc;
            position: relative;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%);
            background-size: 10px 10px;
            margin: 10px 0;
        }
        .centroid-point {
            width: 6px;
            height: 6px;
            background: red;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .stats {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Enhanced Target Tracking Feature Test</h1>
        <p>This test demonstrates the enhanced feature parameters for better target identification and tracking.</p>
        
        <div class="controls">
            <button onclick="createTestImage()">Create Test Image</button>
            <button onclick="extractFeatures()">Extract Enhanced Features</button>
            <button onclick="compareFeatures()">Compare Features</button>
            <button onclick="clearTest()">Clear</button>
        </div>
        
        <canvas id="testCanvas" class="test-canvas" width="400" height="300"></canvas>
        
        <div class="feature-display" id="featureDisplay">
            <!-- Features will be displayed here -->
        </div>
        
        <div class="stats" id="statsDisplay">
            <strong>Test Status:</strong> Ready to test enhanced tracking features
        </div>
    </div>

    <script src="static/js/tracker.js"></script>
    <script>
        let testTracker = null;
        let testFeatures = [];
        
        function createTestImage() {
            const canvas = document.getElementById('testCanvas');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Create test objects with different colors and shapes
            // Object 1: Red rectangle
            ctx.fillStyle = '#ff4444';
            ctx.fillRect(50, 50, 80, 60);
            
            // Object 2: Blue circle
            ctx.fillStyle = '#4444ff';
            ctx.beginPath();
            ctx.arc(200, 100, 40, 0, 2 * Math.PI);
            ctx.fill();
            
            // Object 3: Green triangle
            ctx.fillStyle = '#44ff44';
            ctx.beginPath();
            ctx.moveTo(300, 50);
            ctx.lineTo(350, 120);
            ctx.lineTo(250, 120);
            ctx.closePath();
            ctx.fill();
            
            // Object 4: Multi-colored rectangle
            const gradient = ctx.createLinearGradient(50, 200, 150, 250);
            gradient.addColorStop(0, '#ff0000');
            gradient.addColorStop(0.5, '#00ff00');
            gradient.addColorStop(1, '#0000ff');
            ctx.fillStyle = gradient;
            ctx.fillRect(50, 200, 100, 50);
            
            updateStats('Test image created with 4 objects of different colors and shapes');
        }
        
        function extractFeatures() {
            const canvas = document.getElementById('testCanvas');
            const ctx = canvas.getContext('2d');
            
            if (!testTracker) {
                testTracker = new Tracker({
                    encoder: {
                        imageWidth: canvas.width,
                        imageHeight: canvas.height
                    }
                });
            }
            
            // Define test bounding boxes for the objects
            const testBboxes = [
                { x: 50, y: 50, w: 80, h: 60, class: 'rectangle' },
                { x: 160, y: 60, w: 80, h: 80, class: 'circle' },
                { x: 250, y: 50, w: 100, h: 70, class: 'triangle' },
                { x: 50, y: 200, w: 100, h: 50, class: 'gradient' }
            ];
            
            testFeatures = [];
            
            // Extract features for each object
            testBboxes.forEach(async (bbox, index) => {
                try {
                    const features = await testTracker.encoder.encode(ctx, bbox);
                    if (features) {
                        testFeatures.push({
                            bbox: bbox,
                            features: features,
                            index: index
                        });
                        
                        displayFeatures(features, index, bbox.class);
                    }
                } catch (error) {
                    console.error('Error extracting features for object', index, error);
                }
            });
            
            updateStats(`Extracting enhanced features for ${testBboxes.length} objects...`);
        }
        
        function displayFeatures(features, index, objectClass) {
            const display = document.getElementById('featureDisplay');
            
            const card = document.createElement('div');
            card.className = 'feature-card';
            card.innerHTML = `
                <h3>Object ${index + 1} (${objectClass})</h3>
                
                <div><strong>Geometric Features:</strong></div>
                <div>Aspect Ratio: ${features.geometric[0].toFixed(3)}</div>
                <div>Normalized Area: ${features.geometric[1].toFixed(3)}</div>
                <div>Centroid: (${features.geometric[5].toFixed(3)}, ${features.geometric[6].toFixed(3)})</div>
                <div>Compactness: ${features.geometric[7].toFixed(3)}</div>
                
                ${features.enhanced ? `
                <div><strong>Enhanced Features:</strong></div>
                <div>Color Centroid: (${features.enhanced.colorCentroid.x.toFixed(3)}, ${features.enhanced.colorCentroid.y.toFixed(3)})</div>
                <div class="centroid-display">
                    <div class="centroid-point" style="left: ${features.enhanced.colorCentroid.x * 100}%; top: ${features.enhanced.colorCentroid.y * 100}%;"></div>
                </div>
                <div>Overall Brightness: ${features.enhanced.overallBrightness.toFixed(1)}</div>
                <div>Color Variance: ${features.enhanced.colorVariance.toFixed(1)}</div>
                <div>Color Entropy: ${features.enhanced.colorEntropy.toFixed(2)}</div>
                
                ${features.enhanced.dominantColors ? `
                <div><strong>Dominant Colors:</strong></div>
                <div>
                    ${features.enhanced.dominantColors.map(color => 
                        `<span class="color-swatch" style="background-color: rgb(${Math.round(color.color[0])}, ${Math.round(color.color[1])}, ${Math.round(color.color[2])})" title="Weight: ${(color.weight * 100).toFixed(1)}%"></span>`
                    ).join('')}
                </div>
                ` : ''}
                ` : 'Enhanced features not available'}
            `;
            
            display.appendChild(card);
        }
        
        function compareFeatures() {
            if (testFeatures.length < 2) {
                updateStats('Need at least 2 objects to compare features');
                return;
            }
            
            const display = document.getElementById('featureDisplay');
            const comparisonCard = document.createElement('div');
            comparisonCard.className = 'feature-card';
            comparisonCard.style.gridColumn = '1 / -1';
            
            let comparisonHTML = '<h3>Feature Comparison Results</h3>';
            
            // Compare all pairs of objects
            for (let i = 0; i < testFeatures.length; i++) {
                for (let j = i + 1; j < testFeatures.length; j++) {
                    const obj1 = testFeatures[i];
                    const obj2 = testFeatures[j];
                    
                    // Basic color similarity
                    let colorSim = 0;
                    if (obj1.features.color && obj2.features.color) {
                        colorSim = cosineSimilarity(obj1.features.color, obj2.features.color);
                    }
                    
                    // Enhanced similarity if available
                    let enhancedSim = 0;
                    if (obj1.features.enhanced && obj2.features.enhanced) {
                        // Color centroid distance
                        const centroidDist = Math.sqrt(
                            Math.pow(obj1.features.enhanced.colorCentroid.x - obj2.features.enhanced.colorCentroid.x, 2) +
                            Math.pow(obj1.features.enhanced.colorCentroid.y - obj2.features.enhanced.colorCentroid.y, 2)
                        );
                        
                        // Brightness similarity
                        const brightnessSim = 1 - Math.abs(obj1.features.enhanced.overallBrightness - obj2.features.enhanced.overallBrightness) / 255;
                        
                        enhancedSim = (Math.exp(-centroidDist * 5) + brightnessSim) / 2;
                    }
                    
                    comparisonHTML += `
                        <div style="margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 4px;">
                            <strong>Object ${i + 1} vs Object ${j + 1}:</strong><br>
                            Color Histogram Similarity: ${(colorSim * 100).toFixed(1)}%<br>
                            ${enhancedSim > 0 ? `Enhanced Features Similarity: ${(enhancedSim * 100).toFixed(1)}%` : 'Enhanced features not available'}
                        </div>
                    `;
                }
            }
            
            comparisonCard.innerHTML = comparisonHTML;
            display.appendChild(comparisonCard);
            
            updateStats(`Compared ${testFeatures.length} objects using enhanced feature parameters`);
        }
        
        function clearTest() {
            const canvas = document.getElementById('testCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            document.getElementById('featureDisplay').innerHTML = '';
            testFeatures = [];
            
            updateStats('Test cleared - ready for new test');
        }
        
        function updateStats(message) {
            document.getElementById('statsDisplay').innerHTML = `<strong>Test Status:</strong> ${message}`;
        }
        
        // Initialize test
        window.addEventListener('load', () => {
            updateStats('Enhanced tracking test ready - click "Create Test Image" to begin');
        });
    </script>
</body>
</html>
